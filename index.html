<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z'/%3E%3Ccircle cx='12' cy='10' r='3'/%3E%3C/svg%3E" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GPS Tracker Panama - Cobros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { '50': '#eff6ff', '100': '#dbeafe', '200': '#bfdbfe', '300': '#93c5fd', '400': '#60a5fa', '500': '#3b82f6', '600': '#2563eb', '700': '#1d4ed8', '800': '#1e40af', '900': '#1e3a8a', '950': '#172554' },
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        #toaster-container { position: fixed; top: 1rem; right: 1rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background-color: white; color: #333; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); display: flex; align-items: center; opacity: 0; transition: all 0.3s ease; transform: translateX(100%); max-width: 350px; }
        .dark .toast { background-color: #374151; color: #f3f4f6; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { border-left: 4px solid #22c55e; }
        .toast-error { border-left: 4px solid #ef4444; }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react-dom": "https://aistudiocdn.com/react-dom@^19.2.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.553.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.3.0",
    "firebase/": "https://aistudiocdn.com/firebase@^12.5.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "jspdf": "https://aistudiocdn.com/jspdf@^3.0.3",
    "jspdf-autotable": "https://aistudiocdn.com/jspdf-autotable@^5.0.2",
    "xlsx": "https://aistudiocdn.com/xlsx@^0.18.5"
  }
}
</script>
</head>
<body class="bg-slate-50 dark:bg-slate-900">
    <div id="root"></div>
    <div id="toaster-container"></div>

    <!-- Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@0.378.0/dist/lucide-react.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://unpkg.com/@google/generative-ai@0.11.3/dist/index.js"></script>
    
    <script type="text/babel" data-presets="react">
        const { useState, useEffect, createContext, useContext, useMemo, useCallback, forwardRef, useRef } = React;
        const { createRoot } = ReactDOM;
        const { createPortal } = ReactDOM;
        const {
            X, MapPin, Grid, Users, FileText, Sun, Moon, Bell, LogOut, PlusCircle, Search, Copy, Upload,
            Edit, Trash2, FileDown, Bot, Send, BrainCircuit, Zap, Loader, ArrowRight, DollarSign, UserCheck, UserX
        } = lucide;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } = window.Recharts;
        const { jsPDF } = window.jspdf;
        const XLSX = window.XLSX;
        const { GoogleGenerativeAI } = genai;

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAEAnhu4mzqnRKu5yRv4mh7PKCmwi5IeWA",
            authDomain: "gps-tracker-cobros.firebaseapp.com",
            projectId: "gps-tracker-cobros",
            storageBucket: "gps-tracker-cobros.appspot.com",
            messagingSenderId: "1072959630335",
            appId: "1:1072959630335:web:d498eea7f4135835acd5ca"
        };

        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let genAI;
        const geminiApiKey = ""; // <-- Si tienes una API Key de Gemini, ponla aquí entre las comillas. Si no, el chatbot no funcionará.
        if (geminiApiKey) {
          genAI = new GoogleGenerativeAI(geminiApiKey);
        }

        // --- Toaster (Notifications) ---
        const toast = {
            success: (message) => showToast(message, 'success'),
            error: (message) => showToast(message, 'error'),
        };
        function showToast(message, type = 'success') {
            const container = document.getElementById('toaster-container');
            if (!container) return;
            const isDark = document.documentElement.classList.contains('dark');
            const toastElement = document.createElement('div');
            toastElement.className = `toast toast-${type} ${isDark ? 'dark' : ''}`;
            toastElement.textContent = message;
            container.appendChild(toastElement);
            setTimeout(() => toastElement.classList.add('show'), 10);
            setTimeout(() => {
                toastElement.classList.remove('show');
                setTimeout(() => toastElement.remove(), 300);
            }, 4000);
        }

        // --- UI Components ---
        const Card = ({ children, className = '' }) => <div className={`bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden ${className}`}>{children}</div>;
        const CardHeader = ({ children, className = '' }) => <div className={`p-4 sm:p-6 border-b border-slate-200 dark:border-slate-700 ${className}`}>{children}</div>;
        const CardContent = ({ children, className = '' }) => <div className={`p-4 sm:p-6 ${className}`}>{children}</div>;

        const Button = forwardRef(({ children, className = '', variant = 'primary', ...props }, ref) => {
            const base = 'inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none px-4 py-2';
            const variants = { primary: 'bg-primary-600 text-white hover:bg-primary-700 focus:ring-primary-500 dark:bg-primary-500 dark:hover:bg-primary-600', secondary: 'bg-slate-100 text-slate-900 hover:bg-slate-200 focus:ring-slate-400 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600', danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500', ghost: 'hover:bg-slate-100 dark:hover:bg-slate-700', };
            return <button ref={ref} className={`${base} ${variants[variant]} ${className}`} {...props}>{children}</button>;
        });

        const Input = forwardRef(({ label, id, ...props }, ref) => <div><label htmlFor={id} className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{label}</label><input ref={ref} id={id} className="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500" {...props} /></div>);
        const Select = forwardRef(({ label, id, children, ...props }, ref) => <div><label htmlFor={id} className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{label}</label><select ref={ref} id={id} className="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500" {...props}>{children}</select></div>);
        const Badge = ({ children, color }) => { const colors = { green: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300', yellow: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300', red: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300', gray: 'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300', }; return <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colors[color]}`}>{children}</span>; };
        const Modal = ({ isOpen, onClose, title, children }) => { if (!isOpen) return null; return createPortal(<div className="fixed inset-0 bg-black/60 z-50 flex justify-center items-center p-4" onClick={onClose}><div className="bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col" onClick={(e) => e.stopPropagation()}><div className="flex justify-between items-center p-4 border-b dark:border-slate-700"><h2 className="text-xl font-semibold">{title}</h2><Button variant="ghost" onClick={onClose} className="!p-1 h-auto"><X size={20} /></Button></div><div className="p-6 overflow-y-auto">{children}</div></div></div>, document.body); };
        const Textarea = forwardRef(({ label, id, ...props }, ref) => <div><label htmlFor={id} className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{label}</label><textarea ref={ref} id={id} className="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500" {...props} /></div>);

        // --- Types (Enums) ---
        const PaymentFrequency = { Monthly: 'Mensual', Annual: 'Anual' };
        const PaymentStatus = { Paid: 'Pagado', Pending: 'Pendiente', Overdue: 'Vencido' };
        const ServiceType = { GPS_SALE: 'GPS - Venta', GPS_RENTAL: 'GPS - Alquiler', PORTABLE_GPS_SALE: 'GPS Portátil - Venta', PORTABLE_GPS_RENTAL: 'GPS Portátil - Alquiler' };

        // --- App Contexts ---
        const AuthContext = createContext(null);
        const DataContext = createContext(null);

        // --- Auth Provider ---
        const AuthProvider = ({ children }) => { const [user, setUser] = useState(null); const [loading, setLoading] = useState(true); useEffect(() => auth.onAuthStateChanged(user => { setUser(user); setLoading(false); }), []); return <AuthContext.Provider value={{ user, loading }}>{children}</AuthContext.Provider>; };

        // --- Firestore Data Hook ---
        function useFirestoreData(userId) {
            const [clients, setClients] = useState([]);
            const [payments, setPayments] = useState([]);
            const [loading, setLoading] = useState(true);

            const convertTimestamps = (data) => Object.entries(data).reduce((acc, [key, value]) => ({ ...acc, [key]: value instanceof firebase.firestore.Timestamp ? value.toDate().toISOString() : value }), {});

            useEffect(() => {
                if (!userId) { setLoading(false); setClients([]); setPayments([]); return; }
                setLoading(true);
                const unsubClients = db.collection('clients').where('userId', '==', userId).onSnapshot(snap => { setClients(snap.docs.map(doc => ({ id: doc.id, ...convertTimestamps(doc.data()) }))); setLoading(false); }, err => { console.error(err); toast.error("Error al cargar clientes."); setLoading(false); });
                const unsubPayments = db.collection('payments').where('userId', '==', userId).onSnapshot(snap => setPayments(snap.docs.map(doc => ({ id: doc.id, ...convertTimestamps(doc.data()) }))), err => { console.error(err); toast.error("Error al cargar pagos."); });
                return () => { unsubClients(); unsubPayments(); };
            }, [userId]);

            const addClient = (data) => db.collection('clients').add({ ...data, userId });
            const updateClient = ({ id, ...data }) => db.collection('clients').doc(id).update(data);
            const deleteClient = (id) => db.collection('clients').doc(id).delete();
            const addPayment = (data) => db.collection('payments').add({ ...data, userId });
            const getClientById = useCallback((id) => clients.find(c => c.id === id), [clients]);
            const addMultipleClients = async (clientsData) => {
                const batch = db.batch();
                clientsData.forEach(client => {
                    const docRef = db.collection("clients").doc();
                    const paymentDate = new Date(client.nextPaymentDate);
                    const adjustedDate = new Date(paymentDate.getTime() + (paymentDate.getTimezoneOffset() * 60000));
                    batch.set(docRef, { ...client, nextPaymentDate: adjustedDate, userId });
                });
                await batch.commit();
            };

            return { clients, payments, loading, addClient, updateClient, deleteClient, addPayment, getClientById, addMultipleClients };
        }
        
        // --- Gemini Service ---
        const getChatbotResponse = async (history, newMessage, isThinkingMode, clients, payments) => {
            if (!genAI) return "El Asistente de IA no está configurado. Se necesita una API Key de Gemini.";
            try {
                const modelName = isThinkingMode ? "gemini-pro" : "gemini-1.5-flash";
                const model = genAI.getGenerativeModel({ model: modelName });
                const dataContext = `Contexto de Datos (JSON):\nClientes: ${JSON.stringify(clients, null, 2)}\nPagos: ${JSON.stringify(payments, null, 2)}`;
                const systemInstruction = `Eres un asistente experto para "GPS Tracker Panama". Tu rol es ayudar al usuario a gestionar los datos de sus clientes y pagos. Eres amigable, conciso y profesional. Analiza los datos JSON proporcionados para responder preguntas. La fecha de hoy es ${new Date().toLocaleDateString()}.`;
                const fullHistory = [{ role: "user", parts: [{ text: systemInstruction + "\n" + dataContext }] }, { role: "model", parts: [{ text: "Entendido. Estoy listo para ayudar." }] }, ...history, { role: "user", parts: [{ text: newMessage }] }];

                const chat = model.startChat({ history: fullHistory.slice(0, -1) });
                const result = await chat.sendMessage(newMessage);
                return result.response.text();

            } catch (error) {
                console.error("Gemini API call failed:", error);
                toast.error("Error de comunicación con la IA.");
                return "Lo siento, no pude procesar tu solicitud.";
            }
        };

        // --- App Components ---
        const DashboardComponent = ({ setView }) => {
            const { clients } = useContext(DataContext);
            const getClientPaymentStatus = useCallback((client, today) => {
                const nextPaymentDate = new Date(client.nextPaymentDate);
                if (nextPaymentDate < today) return PaymentStatus.Overdue;
                const daysUntilPayment = (nextPaymentDate.getTime() - today.getTime()) / (1000 * 3600 * 24);
                return daysUntilPayment <= 15 ? PaymentStatus.Pending : PaymentStatus.Paid;
            }, []);
            const stats = useMemo(() => {
                const today = new Date();
                const clientStatus = clients.map(c => getClientPaymentStatus(c, today));
                return { totalClients: clients.length, monthlyRevenue: clients.reduce((acc, c) => c.paymentFrequency === PaymentFrequency.Monthly ? acc + Number(c.paymentAmount) : acc, 0), paid: clientStatus.filter(s => s === PaymentStatus.Paid).length, pending: clientStatus.filter(s => s === PaymentStatus.Pending).length, overdue: clientStatus.filter(s => s === PaymentStatus.Overdue).length, };
            }, [clients, getClientPaymentStatus]);
            const chartData = [ { name: PaymentStatus.Paid, value: stats.paid }, { name: PaymentStatus.Pending, value: stats.pending }, { name: PaymentStatus.Overdue, value: stats.overdue }, ];
            const COLORS = { [PaymentStatus.Paid]: '#22c55e', [PaymentStatus.Pending]: '#f59e0b', [PaymentStatus.Overdue]: '#ef4444' };
            const upcomingPayments = clients.filter(c => getClientPaymentStatus(c, new Date()) === PaymentStatus.Pending).sort((a, b) => new Date(a.nextPaymentDate).getTime() - new Date(b.nextPaymentDate).getTime()).slice(0, 5);
            return ( <div className="space-y-6"> <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-4"> <Card><CardContent><div className="flex items-center justify-between"><div><p className="text-sm text-slate-500">Total de Clientes</p><p className="text-2xl font-bold">{stats.totalClients}</p></div><div className="p-3 bg-primary-100 rounded-lg"><Users className="text-primary-500" /></div></div></CardContent></Card> <Card><CardContent><div className="flex items-center justify-between"><div><p className="text-sm text-slate-500">Ingreso Mensual Est.</p><p className="text-2xl font-bold">${stats.monthlyRevenue.toLocaleString()}</p></div><div className="p-3 bg-primary-100 rounded-lg"><DollarSign className="text-primary-500" /></div></div></CardContent></Card> <Card><CardContent><div className="flex items-center justify-between"><div><p className="text-sm text-slate-500">Activos y Pendientes</p><p className="text-2xl font-bold">{stats.paid + stats.pending}</p></div><div className="p-3 bg-primary-100 rounded-lg"><UserCheck className="text-primary-500" /></div></div></CardContent></Card> <Card><CardContent><div className="flex items-center justify-between"><div><p className="text-sm text-slate-500">Pagos Vencidos</p><p className="text-2xl font-bold">{stats.overdue}</p></div><div className="p-3 bg-primary-100 rounded-lg"><UserX className="text-primary-500" /></div></div></CardContent></Card> </div> <div className="grid gap-6 lg:grid-cols-3"> <Card className="lg:col-span-2"> <CardHeader><h3 className="font-semibold">Resumen de Estado de Pagos</h3></CardHeader> <CardContent> <ResponsiveContainer width="100%" height={300}> <PieChart> <Pie data={chartData} cx="50%" cy="50%" labelLine={false} outerRadius={80} fill="#8884d8" dataKey="value" nameKey="name" label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}> {chartData.map((entry) => <Cell key={`cell-${entry.name}`} fill={COLORS[entry.name]} />)} </Pie> <Tooltip /> <Legend /> </PieChart> </ResponsiveContainer> </CardContent> </Card> <Card> <CardHeader><h3 className="font-semibold">Próximos Pagos</h3></CardHeader> <CardContent>{upcomingPayments.length > 0 ? <ul className="space-y-3">{upcomingPayments.map(c => <li key={c.id} className="flex justify-between items-center"><div><p className="font-medium">{c.name}</p><p className="text-sm text-slate-500">Vence: {new Date(c.nextPaymentDate).toLocaleDateString()}</p></div><p>${c.paymentAmount.toLocaleString()}</p></li>)}</ul> : <p>No hay pagos próximos.</p>}</CardContent> </Card> </div> </div> );
        };
        const ClientManagementComponent = () => { const context = useContext(DataContext); const [isModalOpen, setIsModalOpen] = useState(false); const [editingClient, setEditingClient] = useState(undefined); const [searchQuery, setSearchQuery] = useState(''); const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false); const [clientToDelete, setClientToDelete] = useState(null); const [statementClient, setStatementClient] = useState(null); const [isImportModalOpen, setIsImportModalOpen] = useState(false); const [statusFilter, setStatusFilter] = useState('all'); const isClientActive = (client) => { const diffDays = (new Date().getTime() - new Date(client.nextPaymentDate).getTime()) / (1000 * 3600 * 24); return diffDays <= 60; }; const filteredClients = useMemo(() => context?.clients.filter(client => (client.name.toLowerCase().includes(searchQuery.toLowerCase()) || client.email.toLowerCase().includes(searchQuery.toLowerCase()) || (client.ruc && client.ruc.includes(searchQuery))) && (statusFilter === 'all' || (statusFilter === 'active' ? isClientActive(client) : !isClientActive(client)))), [context, searchQuery, statusFilter]); if (!context) return null; const { addClient, updateClient, deleteClient, payments, addMultipleClients } = context; const handleSave = (clientData) => { if (clientData.id) { updateClient(clientData).then(() => toast.success('¡Cliente actualizado!')); } else { addClient(clientData).then(() => toast.success('¡Cliente añadido!')); } setIsModalOpen(false); }; const confirmDelete = () => { if (clientToDelete) deleteClient(clientToDelete).then(() => toast.success('¡Cliente eliminado!')); setIsDeleteModalOpen(false); }; const handleCopyForSheets = () => { const header = ['Nombre', 'RUC', 'Teléfono', 'Correo Electrónico', 'Tipo de Servicio', 'Unidades GPS', 'Monto de Pago', 'Frecuencia de Pago', 'Próxima Fecha de Pago'].join('\t'); const rows = filteredClients.map(c => [ c.name, c.ruc || '', c.phone, c.email, c.serviceType, c.gpsUnits, c.paymentAmount, c.paymentFrequency, new Date(c.nextPaymentDate).toISOString().split('T')[0] ].join('\t')).join('\n'); navigator.clipboard.writeText(header + '\n' + rows).then(() => toast.success('Datos copiados.'), () => toast.error('Error al copiar.')); }; return ( <> <Card> <CardHeader className="flex flex-col md:flex-row justify-between items-center gap-4"> <div className="flex items-center gap-2 w-full md:w-auto"> <div className="relative"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={20} /><input type="text" placeholder="Buscar clientes..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full pl-10 pr-4 py-2 border rounded-md dark:bg-slate-700" /></div> <Select label="" value={statusFilter} onChange={e => setStatusFilter(e.target.value)}><option value="all">Todos</option><option value="active">Activos</option><option value="inactive">Inactivos</option></Select> </div> <div className="flex items-center space-x-2"><Button variant="secondary" onClick={handleCopyForSheets}><Copy className="mr-2 h-4 w-4" />Copiar</Button><Button variant="secondary" onClick={() => setIsImportModalOpen(true)}><Upload className="mr-2 h-4 w-4" />Importar</Button><Button onClick={() => { setEditingClient(undefined); setIsModalOpen(true); }}><PlusCircle className="mr-2 h-4 w-4" />Nuevo</Button></div> </CardHeader> <CardContent> <div className="overflow-x-auto"> <table className="w-full text-sm"> <thead className="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700"><tr><th className="px-6 py-3">Cliente</th><th className="px-6 py-3">Contacto</th><th className="px-6 py-3">Plan</th><th className="px-6 py-3">Próximo Pago</th><th className="px-6 py-3">Estado</th><th className="px-6 py-3 text-right">Acciones</th></tr></thead> <tbody> {filteredClients.map(client => <tr key={client.id} className="bg-white dark:bg-slate-800 border-b dark:border-slate-700"> <td className="px-6 py-4 font-medium">{client.name}</td> <td className="px-6 py-4"><div>{client.phone}</div><div>{client.email}</div></td> <td className="px-6 py-4"><div>${client.paymentAmount}/{client.paymentFrequency === PaymentFrequency.Monthly ? 'mes' : 'año'}</div><div className="text-sm text-slate-500">{client.gpsUnits} unidades</div></td> <td className="px-6 py-4">{new Date(client.nextPaymentDate).toLocaleDateString()}</td> <td className="px-6 py-4"><Badge color={isClientActive(client) ? 'green' : 'gray'}>{isClientActive(client) ? 'Activo' : 'Inactivo'}</Badge></td> <td className="px-6 py-4 text-right"><div className="flex justify-end space-x-1"><Button variant="ghost" className="!p-2 h-auto" onClick={() => setStatementClient(client)}><FileText size={16} /></Button><Button variant="ghost" className="!p-2 h-auto" onClick={() => { setEditingClient(client); setIsModalOpen(true); }}><Edit size={16} /></Button><Button variant="ghost" className="!p-2 h-auto text-red-500" onClick={() => { setClientToDelete(client.id); setIsDeleteModalOpen(true); }}><Trash2 size={16} /></Button></div></td> </tr>)} </tbody> </table> {filteredClients.length === 0 && <p className="text-center py-8 text-slate-500">No se encontraron clientes.</p>} </div> </CardContent> </Card> <ClientFormModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} client={editingClient} onSave={handleSave} /> <DeleteConfirmationModal isOpen={isDeleteModalOpen} onClose={() => setIsDeleteModalOpen(false)} onConfirm={confirmDelete} /> {statementClient && <StatementModal client={statementClient} payments={payments} onClose={() => setStatementClient(null)} />} <ImportModal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} onImport={addMultipleClients} /> </> ); };
        const ClientFormModal = ({ isOpen, onClose, client, onSave }) => { const [formData, setFormData] = useState({}); useEffect(() => { setFormData(client ? { ...client, nextPaymentDate: new Date(client.nextPaymentDate).toISOString().split('T')[0] } : { gpsUnits: 1, paymentFrequency: PaymentFrequency.Monthly, serviceType: ServiceType.GPS_RENTAL, nextPaymentDate: new Date().toISOString().split('T')[0] }) }, [client, isOpen]); const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value })); const handleSubmit = (e) => { e.preventDefault(); const paymentDate = new Date(formData.nextPaymentDate); const adjustedDate = new Date(paymentDate.getTime() + (paymentDate.getTimezoneOffset() * 60000)); onSave({ ...formData, gpsUnits: Number(formData.gpsUnits), paymentAmount: Number(formData.paymentAmount), nextPaymentDate: adjustedDate.toISOString() }); }; return <Modal isOpen={isOpen} onClose={onClose} title={client ? 'Editar Cliente' : 'Añadir Nuevo Cliente'}><form onSubmit={handleSubmit} className="space-y-4"> <div className="grid grid-cols-1 md:grid-cols-2 gap-4"> <Input label="Nombre o Empresa" name="name" value={formData.name || ''} onChange={handleChange} required /> <Input label="RUC (Opcional)" name="ruc" value={formData.ruc || ''} onChange={handleChange} /> <Input label="Teléfono" name="phone" value={formData.phone || ''} onChange={handleChange} required /> <Input label="Correo Electrónico" name="email" type="email" value={formData.email || ''} onChange={handleChange} required /> <Select label="Tipo de Servicio" name="serviceType" value={formData.serviceType} onChange={handleChange}>{Object.values(ServiceType).map(t => <option key={t} value={t}>{t}</option>)}</Select> <Input label="Unidades GPS" name="gpsUnits" type="number" value={formData.gpsUnits || ''} onChange={handleChange} required min="1" /> <Input label="Monto de Pago ($)" name="paymentAmount" type="number" value={formData.paymentAmount || ''} onChange={handleChange} required min="0" /> <Select label="Frecuencia de Pago" name="paymentFrequency" value={formData.paymentFrequency} onChange={handleChange}><option value={PaymentFrequency.Monthly}>Mensual</option><option value={PaymentFrequency.Annual}>Anual</option></Select> <Input label="Próxima Fecha de Pago" name="nextPaymentDate" type="date" value={formData.nextPaymentDate || ''} onChange={handleChange} required /> </div> <div className="flex justify-end space-x-2"><Button type="button" variant="secondary" onClick={onClose}>Cancelar</Button><Button type="submit">{client ? 'Actualizar' : 'Crear'}</Button></div> </form></Modal>; };
        const DeleteConfirmationModal = ({ isOpen, onClose, onConfirm }) => <Modal isOpen={isOpen} onClose={onClose} title="Confirmar Eliminación"><p>¿Está seguro? Esta acción no se puede deshacer.</p><div className="flex justify-end space-x-2 mt-4"><Button variant="secondary" onClick={onClose}>Cancelar</Button><Button variant="danger" onClick={onConfirm}>Eliminar</Button></div></Modal>;
        const StatementModal = ({ client, payments, onClose }) => { const [year, setYear] = useState(new Date().getFullYear()); const clientPayments = payments.filter(p => p.clientId === client.id && new Date(p.paymentDate).getFullYear() === year); const generatePdf = () => { const doc = new jsPDF(); doc.text(`Estado de Cuenta: ${client.name} (${year})`, 14, 22); (doc).autoTable({ head: [['Fecha', 'Monto']], body: clientPayments.map(p => [new Date(p.paymentDate).toLocaleDateString(), `$${p.amount}`]), startY: 30 }); doc.save(`Estado_de_Cuenta_${client.name}.pdf`); }; return <Modal isOpen={true} onClose={onClose} title="Estado de Cuenta"><div className="space-y-4"><Select label="Año" value={year} onChange={e => setYear(Number(e.target.value))}>{[2025, 2024, 2023, 2022].map(y => <option key={y} value={y}>{y}</option>)}</Select><Button onClick={generatePdf} disabled={clientPayments.length === 0}><FileDown className="mr-2 h-4 w-4" />Descargar PDF</Button><div className="overflow-auto max-h-64"><table className="w-full text-sm"><thead><tr><th>Fecha</th><th>Monto</th></tr></thead><tbody>{clientPayments.map(p => <tr key={p.id}><td>{new Date(p.paymentDate).toLocaleDateString()}</td><td>${p.amount}</td></tr>)}</tbody></table></div></div></Modal>; };
        const ImportModal = ({ isOpen, onClose, onImport }) => { const [data, setData] = useState(''); const handleImport = () => { try { const lines = data.trim().split('\n').slice(1); const clients = lines.map(line => { const [name, ruc, phone, email, serviceType, gpsUnits, paymentAmount, paymentFrequency, nextPaymentDate] = line.split('\t'); return { name, ruc, phone, email, serviceType, gpsUnits: Number(gpsUnits), paymentAmount: Number(paymentAmount), paymentFrequency, nextPaymentDate }; }); onImport(clients).then(() => { toast.success(`${clients.length} clientes importados.`); onClose(); }); } catch (e) { toast.error("Error al procesar los datos."); } }; return <Modal isOpen={isOpen} onClose={onClose} title="Importar Clientes"><p className="text-sm">Pegue los datos desde su hoja de cálculo (incluyendo encabezado).</p><Textarea label="Datos a importar" value={data} onChange={e => setData(e.target.value)} rows={10} /><div className="flex justify-end space-x-2 mt-4"><Button variant="secondary" onClick={onClose}>Cancelar</Button><Button onClick={handleImport}>Importar</Button></div></Modal>; };
        const PaymentManagementComponent = () => { const context = useContext(DataContext); const [filterMonth, setFilterMonth] = useState(new Date().getMonth() + 1); const [filterYear, setFilterYear] = useState(new Date().getFullYear()); const [statusFilter, setStatusFilter] = useState('All'); const [isModalOpen, setIsModalOpen] = useState(false); const [paymentDetails, setPaymentDetails] = useState(undefined); const getClientPaymentStatusForMonth = useCallback((client, month, year, payments) => { const today = new Date(); const payment = payments.find(p => p.clientId === client.id && new Date(p.paymentDate).getMonth() + 1 === month && new Date(p.paymentDate).getFullYear() === year); if (payment) return { status: PaymentStatus.Paid, payment }; const dueDate = new Date(year, month - 1, new Date(client.nextPaymentDate).getDate()); if (today > dueDate) return { status: PaymentStatus.Overdue, payment: null }; return { status: PaymentStatus.Pending, payment: null }; }, []); const clientsWithStatus = useMemo(() => context?.clients.map(client => ({ ...client, ...getClientPaymentStatusForMonth(client, filterMonth, filterYear, context.payments) })).filter(client => statusFilter === 'All' || client.status === statusFilter), [context, filterMonth, filterYear, statusFilter, getClientPaymentStatusForMonth]); if (!context) return null; const { addPayment, updateClient, getClientById } = context; const handleSave = (paymentData) => { addPayment(paymentData).then(() => { toast.success('Pago registrado.'); const client = getClientById(paymentData.clientId); if (client) { const newNextPaymentDate = new Date(client.nextPaymentDate); newNextPaymentDate.setMonth(newNextPaymentDate.getMonth() + (client.paymentFrequency === PaymentFrequency.Annual ? 12 : 1)); updateClient({ ...client, nextPaymentDate: newNextPaymentDate.toISOString() }); } }); setIsModalOpen(false); }; const MONTHS = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; return ( <> <Card> <CardHeader className="flex flex-wrap justify-between items-center gap-2"> <div className="flex items-center gap-2"> <Select label="" value={filterMonth} onChange={e => setFilterMonth(Number(e.target.value))}>{MONTHS.map((m, i) => <option key={i} value={i + 1}>{m}</option>)}</Select> <Select label="" value={filterYear} onChange={e => setFilterYear(Number(e.target.value))}>{[2025, 2024, 2023, 2022].map(y => <option key={y} value={y}>{y}</option>)}</Select> <Select label="" value={statusFilter} onChange={e => setStatusFilter(e.target.value)}><option value="All">Todos</option><option value={PaymentStatus.Paid}>Pagado</option><option value={PaymentStatus.Pending}>Pendiente</option><option value={PaymentStatus.Overdue}>Vencido</option></Select> </div> <Button onClick={() => { setPaymentDetails(undefined); setIsModalOpen(true); }}><PlusCircle className="mr-2 h-4 w-4" />Registrar Pago</Button> </CardHeader> <CardContent> <div className="overflow-x-auto"> <table className="w-full text-sm"> <thead className="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700"><tr><th className="px-6 py-3">Cliente</th><th className="px-6 py-3">Estado</th><th className="px-6 py-3">Monto</th><th className="px-6 py-3">Fecha de Pago</th><th className="px-6 py-3 text-right">Acción</th></tr></thead> <tbody> {clientsWithStatus.map(client => <tr key={client.id} className="border-b dark:border-slate-700"> <td className="px-6 py-4">{client.name}</td> <td className="px-6 py-4"><Badge color={client.status === PaymentStatus.Paid ? 'green' : client.status === PaymentStatus.Pending ? 'yellow' : 'red'}>{client.status}</Badge></td> <td className="px-6 py-4">${client.paymentAmount}</td> <td className="px-6 py-4">{client.payment ? new Date(client.payment.paymentDate).toLocaleDateString() : 'N/A'}</td> <td className="px-6 py-4 text-right">{client.status !== PaymentStatus.Paid && <Button onClick={() => { setPaymentDetails({ client, month: filterMonth, year: filterYear }); setIsModalOpen(true); }}>Registrar</Button>}</td> </tr>)} </tbody> </table> </div> </CardContent> </Card> <PaymentFormModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSave} details={paymentDetails} clients={context.clients} /> </> ); };
        const PaymentFormModal = ({ isOpen, onClose, onSave, details, clients }) => { const [formData, setFormData] = useState({}); useEffect(() => { if (details) setFormData({ clientId: details.client.id, amount: details.client.paymentAmount, month: details.month, year: details.year, paymentDate: new Date().toISOString().split('T')[0] }); else if (clients?.length > 0) setFormData({ clientId: clients[0].id, amount: clients[0].paymentAmount, month: new Date().getMonth() + 1, year: new Date().getFullYear(), paymentDate: new Date().toISOString().split('T')[0] }); }, [details, clients, isOpen]); const handleChange = (e) => setFormData(p => ({ ...p, [e.target.name]: e.target.value })); const handleSubmit = (e) => { e.preventDefault(); onSave({...formData, amount: Number(formData.amount)}); }; return <Modal isOpen={isOpen} onClose={onClose} title="Registrar Pago"><form onSubmit={handleSubmit} className="space-y-4"> <Select label="Cliente" name="clientId" value={formData.clientId || ''} onChange={handleChange} disabled={!!details}>{(clients || []).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</Select> <Input label="Monto" name="amount" type="number" value={formData.amount || ''} onChange={handleChange} required /> <Input label="Fecha de Pago" name="paymentDate" type="date" value={formData.paymentDate || ''} onChange={handleChange} required /> <div className="flex justify-end space-x-2"><Button type="button" variant="secondary" onClick={onClose}>Cancelar</Button><Button type="submit">Guardar</Button></div> </form></Modal>; };
        const ChatbotComponent = () => { const [isOpen, setIsOpen] = useState(false); const [messages, setMessages] = useState([{ id: 1, text: "¡Hola! ¿Cómo puedo ayudarte?", role: 'model' }]); const [input, setInput] = useState(''); const [isLoading, setIsLoading] = useState(false); const [isThinkingMode, setIsThinkingMode] = useState(false); const dataContext = useContext(DataContext); const messagesEndRef = useRef(null); useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]); const handleSend = async () => { if (input.trim() === '' || isLoading || !dataContext || !genAI) return; const newMessages = [...messages, { id: Date.now(), text: input, role: 'user' }]; setMessages(newMessages); setInput(''); setIsLoading(true); const historyForApi = newMessages.slice(1).map(({ role, text }) => ({ role, parts: [{ text }] })); const botResponseText = await getChatbotResponse(historyForApi.slice(0, -1), input, isThinkingMode, dataContext.clients, data-context.payments); setMessages(prev => [...prev, { id: Date.now() + 1, text: botResponseText, role: 'model' }]); setIsLoading(false); }; return ( <> <button onClick={() => setIsOpen(!isOpen)} className="fixed bottom-6 right-6 bg-primary-600 text-white rounded-full p-4 shadow-lg z-50">{isOpen ? <X /> : <Bot />}</button> {isOpen && <div className="fixed bottom-20 right-6 w-[calc(100%-3rem)] sm:w-96 h-[60vh] bg-white dark:bg-slate-800 rounded-xl shadow-2xl flex flex-col z-40 animate-fade-in-up"> <header className="p-4 border-b dark:border-slate-700 flex justify-between items-center"> <div><h3 className="font-semibold">Asistente de IA</h3><div className="flex items-center text-xs text-slate-500">{isThinkingMode ? <BrainCircuit size={14} className="mr-1" /> : <Zap size={14} className="mr-1" />} {isThinkingMode ? "Modo Pensamiento" : "Modo Rápido"}</div></div> <div className="flex items-center"><span className="text-sm mr-2">Pro</span><label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked={isThinkingMode} onChange={() => setIsThinkingMode(!isThinkingMode)} className="sr-only peer" /><div className="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-600"></div></label></div> </header> <main className="flex-1 p-4 overflow-y-auto space-y-4"> {messages.map(msg => <div key={msg.id} className={`flex items-start gap-3 ${msg.role === 'user' ? 'justify-end' : ''}`}><div className={`px-4 py-2 rounded-lg max-w-xs ${msg.role === 'user' ? 'bg-primary-600 text-white' : 'bg-slate-100 dark:bg-slate-700'}`}>{msg.text}</div></div>)} {isLoading && <Loader className="animate-spin text-primary-500" />} <div ref={messagesEndRef} /> </main> <footer className="p-4 border-t dark:border-slate-700"><div className="relative"><input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSend()} placeholder="Escribe un mensaje..." className="w-full pl-3 pr-12 py-2 border rounded-lg dark:bg-slate-700" disabled={isLoading} /><button onClick={handleSend} disabled={isLoading} className="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full text-primary-500"><Send /></button></div></footer> </div>} </> ); };
        const AuthComponent = () => { const [isLogin, setIsLogin] = useState(true); const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [isLoading, setIsLoading] = useState(false); const getFirebaseErrorMessage = (error) => ({ 'auth/user-not-found': 'Usuario no encontrado.', 'auth/wrong-password': 'Contraseña incorrecta.', 'auth/invalid-email': 'Correo inválido.', 'auth/weak-password': 'La contraseña debe tener al menos 6 caracteres.', 'auth/email-already-in-use': 'El correo electrónico ya está en uso.' }[error.code] || 'Ocurrió un error. Inténtalo de nuevo.'); const handleSubmit = async (e) => { e.preventDefault(); setIsLoading(true); try { if (isLogin) { await auth.signInWithEmailAndPassword(email, password); } else { await auth.createUserWithEmailAndPassword(email, password); } toast.success(isLogin ? '¡Bienvenido de nuevo!' : '¡Cuenta creada exitosamente!'); } catch (error) { toast.error(getFirebaseErrorMessage(error)); } finally { setIsLoading(false); } }; return ( <div className="min-h-screen flex items-center justify-center bg-slate-100 dark:bg-slate-900 p-4"> <Card className="w-full max-w-md"> <CardHeader className="text-center"> <div className="flex items-center justify-center mb-4"><MapPin className="text-primary-500 h-8 w-8" /><h1 className="ml-2 text-2xl font-bold">GPS Tracker Panama</h1></div> <h2 className="text-xl font-semibold">{isLogin ? 'Iniciar Sesión' : 'Crear Cuenta'}</h2> </CardHeader> <CardContent> <form onSubmit={handleSubmit} className="space-y-4"> <Input label="Correo Electrónico" type="email" value={email} onChange={(e) => setEmail(e.target.value)} required /> <Input label="Contraseña" type="password" value={password} onChange={(e) => setPassword(e.target.value)} required /> <Button type="submit" className="w-full" disabled={isLoading}>{isLoading ? <Loader className="animate-spin" /> : (isLogin ? 'Ingresar' : 'Crear Cuenta')}</Button> </form> <div className="mt-4 text-center"><button onClick={() => setIsLogin(!isLogin)} className="text-sm text-primary-600 hover:underline dark:text-primary-400">{isLogin ? '¿No tienes una cuenta? Crear una' : '¿Ya tienes una cuenta? Iniciar Sesión'}</button></div> </CardContent> </Card> </div> ); };
        const Layout = ({ children }) => <div className="flex h-screen">{children}</div>;
        const Sidebar = ({ currentView, setView, navigationItems }) => ( <aside className="w-64 bg-white dark:bg-slate-800/50 border-r flex-col hidden lg:flex"><div className="h-16 flex items-center px-6 border-b"><MapPin className="text-primary-500" /><h1 className="ml-2 text-xl font-bold">GPS Tracker</h1></div><nav className="flex-1 px-4 py-4"><ul>{navigationItems.map(item => (<li key={item.name}><button onClick={() => setView(item.view)} className={`w-full flex items-center px-4 py-2 my-1 rounded-lg text-sm ${currentView === item.view ? 'bg-primary-500 text-white' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}><item.icon className="mr-3 h-5 w-5" />{item.name}</button></li>))}</ul></nav></aside> );
        const Header = ({ currentView, navigationItems }) => { const { user } = useContext(AuthContext); const [isDark, setIsDark] = useState(document.documentElement.classList.contains('dark')); const toggleDarkMode = () => { document.documentElement.classList.toggle('dark'); setIsDark(!isDark); }; const viewName = navigationItems.find(item => item.view === currentView)?.name; return ( <header className="h-16 bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm border-b flex items-center justify-between px-6"><h2 className="text-xl font-semibold capitalize">{viewName}</h2><div className="flex items-center space-x-2"><span className="text-sm hidden sm:inline">{user?.email}</span><button onClick={toggleDarkMode} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">{isDark ? <Sun size={20} /> : <Moon size={20} />}</button><Button variant="secondary" onClick={() => auth.signOut()} className="!px-2"><LogOut size={20} /></Button></div></header> ); };

        // --- The Main App ---
        const App = () => { const { user, loading } = useContext(AuthContext); const [view, setView] = useState('dashboard'); const data = useFirestoreData(user?.uid); if (loading) return <div className="flex items-center justify-center h-screen"><Loader className="w-12 h-12 animate-spin text-primary-500" /></div>; if (!user) return <AuthComponent />; const navigationItems = [ { name: 'Panel', icon: Grid, view: 'dashboard' }, { name: 'Clientes', icon: Users, view: 'clients' }, { name: 'Pagos', icon: FileText, view: 'payments' } ]; return ( <DataContext.Provider value={data}> <Layout> <Sidebar currentView={view} setView={setView} navigationItems={navigationItems} /> <div className="flex flex-col flex-1"> <Header currentView={view} navigationItems={navigationItems} /> <main className="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto"> {data.loading && <div className="flex items-center justify-center h-full"><Loader className="w-8 h-8 animate-spin text-primary-500" /></div>} {!data.loading && view === 'dashboard' && <DashboardComponent setView={setView} />} {!data.loading && view === 'clients' && <ClientManagementComponent />} {!data.loading && view === 'payments' && <PaymentManagementComponent />} </main> </div> </Layout> <ChatbotComponent /> </DataContext.Provider> ); };

        const RootApp = () => ( <AuthProvider><App /></AuthProvider> );
        const root = createRoot(document.getElementById('root'));
        root.render(<RootApp />);
</script>
</body>
</html>
```

